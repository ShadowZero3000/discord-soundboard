# I would like to add https://github.com/semantic-release/semantic-release to the flow
# Ideally we'd have semantic-release do the tagging (which will trigger another job)
# So on push to master, run semantic-release, on tag push to prod
# With a prepare plugin: https://github.com/semantic-release/semantic-release/blob/caribou/docs/usage/plugins.md#prepare-plugin
# we can have it automatically update the version file
# But that's going to be a push to the master branch, so how to not repeat ourselves
# will need some thought
# Can do with: git commit -m "updated README [CI SKIP]"
pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - /drone/docker
    volumes:
      - /tmp/cache:/cache
    when:
      event: [push, tag]

  show environment:
    image: node:10.9-jessie
    commands:
      - env
  # Dev build. Occurs on non-master/release branches
  docker-build:
    image: plugins/docker
    repo: registry.codethat.rocks:5000/discord-soundboard
    registry: registry.codethat.rocks:5000
    tags: dev-${CI_BUILD_NUMBER}
    debug: true
    storage_path: /drone/docker
    # Seems to be required to push to the registry on the same host
    custom_dns: [ 192.168.5.1 ]
    network_mode: host
    when:
      event: push
      branch:
        exclude: [master, release/*]

  # Semantic release - Updates versions, changelogs, etc..., and pushes another commit with [skip ci]
  semver-update:
    image: node:10.9-jessie
    commands:
      - if echo "$${DRONE_COMMIT_MESSAGE}" | grep "\[skip semver\]"; then exit 0; fi
      - apt update
      - apt install jq
      - npm install --no-save semantic-release @semantic-release/exec @semantic-release/changelog @semantic-release/git
      - mkdir ~/.ssh -p
      - echo "$${GITHUB_SSH_KEY}" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - chmod +x ./update_version
      - printf "StrictHostKeyChecking no\nUserKnownHostsFile /dev/null\nHost github.com\nUser ShadowZero3000" > ~/.ssh/config
      - npx semantic-release --debug
    when:
      event: push
      branch:
        include: [master, release/*]
    secrets: [ github_ssh_key, github_token ]

  # Prod build - Happens after Semantic release updates changelogs etc...
  docker-build-production:
    image: plugins/docker
    repo: registry.codethat.rocks:5000/discord-soundboard
    registry: registry.codethat.rocks:5000
    tags: "${DRONE_TAG}"
    debug: true
    storage_path: /drone/docker
    # Seems to be required to push to the registry on the same host
    custom_dns: [ 192.168.5.1 ]
    network_mode: host
    when:
      event: tag
      branch:
        include: [master, release/*]

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - /drone/docker
    volumes:
      - /tmp/cache:/cache
    when:
      event: push

  # Dev deploy. Occurs on non-master/release branches
  rancher-dev:
    image: peloton/drone-rancher
    url: http://rancher.codethat.rocks:8080
    access_key: superaccesskey
    secret_key: supersecretkey
    service: dev-discord/discordbot
    docker_image: "registry.codethat.rocks:5000/discord-soundboard:dev-${CI_BUILD_NUMBER}"
    start_first: false
    confirm: true
    when:
      event: push
      branch:
        exclude: [master, release/*]

  # Prod deploy, Occurs on tags
  rancher-production:
    image: peloton/drone-rancher
    url: http://rancher.codethat.rocks:8080
    access_key: superaccesskey
    secret_key: supersecretkey
    service: discordbot/discordbot
    docker_image: "registry.codethat.rocks:5000/discord-soundboard:${DRONE_TAG}"
    confirm: true
    when:
      event: tag
      branch:
        include: [master, release/*]
