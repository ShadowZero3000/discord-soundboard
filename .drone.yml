# I would like to add https://github.com/semantic-release/semantic-release to the flow
# Ideally we'd have semantic-release do the tagging (which will trigger another job)
# So on push to master, run semantic-release, on tag push to prod
# With a prepare plugin: https://github.com/semantic-release/semantic-release/blob/caribou/docs/usage/plugins.md#prepare-plugin
# we can have it automatically update the version file
# But that's going to be a push to the master branch, so how to not repeat ourselves
# will need some thought
pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - /drone/docker
    volumes:
      - /tmp/cache:/cache

  # Dev build
  docker-build:
    image: plugins/docker
    repo: registry.codethat.rocks:5000/discord-soundboard
    registry: registry.codethat.rocks:5000
    tags: dev-${CI_BUILD_NUMBER}
    debug: true
    storage_path: /drone/docker
    # Seems to be required to push to the registry on the same host
    custom_dns: [ 192.168.5.1 ]
    network_mode: host
    when:
      event: push

  docker-build-production:
    image: plugins/docker
    repo: registry.codethat.rocks:5000/discord-soundboard
    registry: registry.codethat.rocks:5000
    tags: "${DRONE_TAG}"
    debug: true
    storage_path: /drone/docker
    # Seems to be required to push to the registry on the same host
    custom_dns: [ 192.168.5.1 ]
    network_mode: host
    when:
      branch: master
      event: tag

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - /drone/docker
    volumes:
      - /tmp/cache:/cache

  rancher-dev:
    image: peloton/drone-rancher
    url: http://rancher.codethat.rocks:8080
    access_key: superaccesskey
    secret_key: supersecretkey
    service: dev-discord/discordbot
    docker_image: "registry.codethat.rocks:5000/discord-soundboard:dev-${CI_BUILD_NUMBER}"
    start_first: false
    confirm: true
    when:
      event: push

  rancher-production:
    image: peloton/drone-rancher
    url: http://rancher.codethat.rocks:8080
    access_key: superaccesskey
    secret_key: supersecretkey
    service: discordbot/discordbot
    docker_image: "registry.codethat.rocks:5000/discord-soundboard:${DRONE_TAG}"
    confirm: true
    when:
      branch: master
      event: tag